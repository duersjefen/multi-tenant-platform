name: Test Platform Configuration

on:
  pull_request:
    paths:
      - 'platform/**'
      - 'lib/**'
      - '.github/workflows/**'
  push:
    branches:
      - main
    paths:
      - 'platform/**'
      - 'lib/**'

jobs:
  test:
    name: Test Platform Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Start platform nginx (for testing)
        run: |
          # Start nginx container for syntax validation
          docker compose -f platform/docker-compose.platform.yml up -d nginx

          # Wait for container to be ready
          sleep 5

      - name: Run platform tests
        run: |
          chmod +x lib/test-platform.sh
          ./lib/test-platform.sh

      - name: Test nginx config syntax
        run: |
          docker exec platform-nginx nginx -t

      - name: Validate docker-compose
        run: |
          docker compose -f platform/docker-compose.platform.yml config > /dev/null

      - name: Check for HTTP/3 configuration
        run: |
          # Verify HTTP/3 is properly configured
          grep -q "listen 443 quic" platform/nginx/conf.d/*.conf || {
            echo "❌ HTTP/3 (QUIC) listeners not found!"
            exit 1
          }

          grep -q "Alt-Svc.*h3=" platform/nginx/nginx.conf || {
            echo "❌ Alt-Svc header not configured!"
            exit 1
          }

          grep -q "443:443/udp" platform/docker-compose.platform.yml || {
            echo "❌ UDP port 443 not exposed!"
            exit 1
          }

          echo "✅ HTTP/3 configuration validated"

      - name: Cleanup
        if: always()
        run: |
          docker compose -f platform/docker-compose.platform.yml down

      - name: Report test results
        if: always()
        run: |
          echo "::notice::Platform configuration tests completed"
