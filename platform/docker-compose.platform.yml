# =============================================================================
# Multi-Tenant Platform Infrastructure
# =============================================================================
# This compose file runs SHARED services for all projects:
# - Nginx reverse proxy (routes to all apps)
# - Certbot (SSL certificates)
# - Prometheus (metrics collection)
# - Grafana (metrics visualization)
# - Alertmanager (alert notifications)
# - Node Exporter (server metrics)
# - cAdvisor (container metrics)
#
# Each individual project has its own docker-compose.yml in /deploy/apps/
# =============================================================================

networks:
  platform:
    name: platform
    driver: bridge

services:
  # ===========================================================================
  # NGINX - Reverse Proxy for All Projects
  # ===========================================================================
  nginx:
    image: macbre/nginx-http3:latest
    container_name: platform-nginx
    restart: unless-stopped
    user: "0"  # Run as root to access SSL certificates
    ports:
      - "80:80"
      - "443:443/tcp"
      - "443:443/udp"  # HTTP/3 (QUIC) support
    volumes:
      # Main nginx config (absolute path - canonical location)
      - /opt/multi-tenant-platform/platform/nginx/nginx.conf:/etc/nginx/nginx.conf:ro

      # Include files (reusable snippets)
      - /opt/multi-tenant-platform/platform/nginx/includes:/etc/nginx/includes:ro

      # Per-app configurations (generated from projects.yml)
      - /opt/multi-tenant-platform/platform/nginx/conf.d:/etc/nginx/conf.d:ro

      # SSL certificates
      - certbot-certs:/etc/letsencrypt:ro
      - certbot-www:/var/www/certbot:ro

      # Logs
      - nginx-logs:/var/log/nginx
    networks:
      - platform
    # Note: No depends_on - nginx is independent of monitoring stack
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================================================
  # NGINX STAGING - Test Platform Changes Safely
  # ===========================================================================
  # This container runs on port 8443 to test nginx config changes before
  # deploying to production. It uses the SAME configs as production.
  #
  # Usage:
  #   docker compose -f platform/docker-compose.platform.yml up -d nginx-staging
  #   Test at https://SERVER_IP:8443
  #   If good: deploy to production nginx
  #   docker compose -f platform/docker-compose.platform.yml down nginx-staging
  # ===========================================================================
  nginx-staging:
    image: macbre/nginx-http3:latest
    container_name: platform-nginx-staging
    restart: "no"  # Don't auto-restart (this is for manual testing)
    user: "0"  # Run as root to access SSL certificates
    ports:
      - "8443:443/tcp"  # Map container 443 to host 8443
      - "8443:443/udp"  # HTTP/3 (QUIC) on 8443
    volumes:
      # Uses SAME configs as production (tests the real thing)
      - /opt/multi-tenant-platform/platform/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - /opt/multi-tenant-platform/platform/nginx/includes:/etc/nginx/includes:ro
      - /opt/multi-tenant-platform/platform/nginx/conf.d:/etc/nginx/conf.d:ro
      - certbot-certs:/etc/letsencrypt:ro
      - certbot-www:/var/www/certbot:ro

      # Separate staging logs
      - nginx-staging-logs:/var/log/nginx
    networks:
      - platform
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # ===========================================================================
  # CERTBOT - SSL Certificate Management
  # ===========================================================================
  certbot:
    image: certbot/certbot:latest
    container_name: platform-certbot
    volumes:
      - certbot-certs:/etc/letsencrypt
      - certbot-www:/var/www/certbot
      - /opt/multi-tenant-platform/platform/scripts/reload-nginx-safe.sh:/scripts/reload-nginx.sh:ro
      - /opt/multi-tenant-platform/lib/provision-ssl-certs.sh:/scripts/provision-ssl-certs.sh:ro
      - /opt/multi-tenant-platform/config/projects.yml:/config/projects.yml:ro
      - /var/run/docker.sock:/var/run/docker.sock  # For docker exec commands
    networks:
      - platform
    # Certbot renewal with deploy hooks (industry best practice)
    # Deploy hook ONLY runs when certificates are actually renewed
    # Also runs daily placeholder replacement check
    entrypoint: /bin/sh -c "
      apk add --no-cache docker-cli python3 py3-yaml openssl > /dev/null 2>&1;
      trap exit TERM;
      while :; do
        certbot renew --deploy-hook '/scripts/reload-nginx.sh' --quiet;
        /scripts/provision-ssl-certs.sh --replace-placeholders 2>&1 || true;
        sleep 12h & wait $${!};
      done"
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # ===========================================================================
  # PROMETHEUS - Metrics Collection
  # ===========================================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: platform-prometheus
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--storage.tsdb.retention.size=10GB'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
    ports:
      - "127.0.0.1:9090:9090"  # Only accessible from localhost
    volumes:
      - /opt/multi-tenant-platform/platform/monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - /opt/multi-tenant-platform/platform/monitoring/prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus-data:/prometheus
    networks:
      - platform
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================================================
  # GRAFANA - Metrics Visualization
  # ===========================================================================
  grafana:
    image: grafana/grafana:latest
    container_name: platform-grafana
    restart: unless-stopped
    ports:
      - "127.0.0.1:3001:3000"  # Only accessible from localhost
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-changeme}
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
      - GF_SERVER_ROOT_URL=https://monitoring.paiss.me
      - GF_PATHS_PROVISIONING=/etc/grafana/provisioning
      - GF_LOG_MODE=console file
      - GF_LOG_LEVEL=info
      - GF_DASHBOARDS_VERSIONS_TO_KEEP=20
      - GF_DASHBOARDS_MIN_REFRESH_INTERVAL=5s
      - GF_SNAPSHOTS_EXTERNAL_ENABLED=false
      - GF_USERS_VIEWERS_CAN_EDIT=false
      - GF_AUTH_LOGIN_MAXIMUM_INACTIVE_LIFETIME_DURATION=7d
      - GF_AUTH_LOGIN_MAXIMUM_LIFETIME_DURATION=30d
      - GF_DATABASE_LOG_QUERIES=false
    volumes:
      - /opt/multi-tenant-platform/platform/monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - /opt/multi-tenant-platform/platform/monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana-data:/var/lib/grafana
    networks:
      - platform
    depends_on:
      - prometheus
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================================================
  # ALERTMANAGER - Alert Routing & Notifications
  # ===========================================================================
  alertmanager:
    image: prom/alertmanager:latest
    container_name: platform-alertmanager
    restart: unless-stopped
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    ports:
      - "127.0.0.1:9093:9093"  # Only accessible from localhost
    volumes:
      - /opt/multi-tenant-platform/platform/monitoring/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager-data:/alertmanager
    networks:
      - platform
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9093/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # ===========================================================================
  # NODE EXPORTER - Server Metrics (CPU, Memory, Disk)
  # ===========================================================================
  node-exporter:
    image: prom/node-exporter:latest
    container_name: platform-node-exporter
    restart: unless-stopped
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    ports:
      - "127.0.0.1:9100:9100"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    networks:
      - platform
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # ===========================================================================
  # CADVISOR - Container Metrics
  # ===========================================================================
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: platform-cadvisor
    restart: unless-stopped
    ports:
      - "127.0.0.1:8080:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    networks:
      - platform
    privileged: true
    devices:
      - /dev/kmsg
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # ===========================================================================
  # NGINX EXPORTER - Nginx Metrics for Prometheus
  # ===========================================================================
  nginx-exporter:
    image: nginx/nginx-prometheus-exporter:latest
    container_name: platform-nginx-exporter
    restart: unless-stopped
    command:
      - '-nginx.scrape-uri=http://nginx:80/nginx-status'
    ports:
      - "127.0.0.1:9113:9113"
    networks:
      - platform
    depends_on:
      - nginx
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # ===========================================================================
  # SSL CERTIFICATE EXPORTER - Certificate Expiry Monitoring
  # ===========================================================================
  ssl-exporter:
    image: enix/x509-certificate-exporter:latest
    container_name: platform-ssl-exporter
    restart: unless-stopped
    command:
      - -d
      - /etc/letsencrypt/live
      - -f
      - /etc/letsencrypt/live/*/fullchain.pem
      - -k
      - "false"
      - --trim-path-components=3
      - -l
      - dns_names
      - --expose-per-cert-error-metrics
      - -b
      - :9793
    ports:
      - "127.0.0.1:9793:9793"
    volumes:
      - certbot-certs:/etc/letsencrypt:ro
    networks:
      - platform
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  # SSL certificates
  certbot-certs:
    name: platform-certbot-certs
  certbot-www:
    name: platform-certbot-www

  # Nginx logs
  nginx-logs:
    name: platform-nginx-logs
  nginx-staging-logs:
    name: platform-nginx-staging-logs

  # Monitoring data
  prometheus-data:
    name: platform-prometheus-data
  grafana-data:
    name: platform-grafana-data
  alertmanager-data:
    name: platform-alertmanager-data